<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Attendance</title>
	<link rel="stylesheet" href="/static/style.css">
</head>
<body>
	{% include 'header.html' %}
	<div class="container">
		<h1 class="page-title">Mark Attendance</h1>
		<div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>
		{% if show_code_form %}
		<div class="card">
			<h2>Enter Access Code</h2>
			<form method="post">
				<div class="form-group">
					<label>Access Code</label>
					<input type="password" name="code" placeholder="Enter access code" required>
				</div>
				<button type="submit" class="btn btn-primary">Submit</button>
			</form>
		</div>
		{% else %}
		<div class="card">
			<video id="video" autoplay playsinline class="video"></video>
			<div class="actions">
				<button id="capture" class="btn btn-primary">Mark Present</button>
			</div>
			<div id="out" class="output"></div>
			<div id="manualEntry" style="display: none; margin-top: 20px;">
				<h3>Manual Entry</h3>
				<form id="manualForm">
					<div class="form-group">
						<label>Day</label>
						<select id="manual_day" required>
							<option value="0">Monday</option>
							<option value="1">Tuesday</option>
							<option value="2">Wednesday</option>
							<option value="3">Thursday</option>
							<option value="4">Friday</option>
							<option value="5">Saturday</option>
							<option value="6">Sunday</option>
						</select>
					</div>
					<div class="form-group">
						<label>Subject</label>
						<select id="manual_subject" required>
							<option value="">-- Select Subject --</option>
						</select>
					</div>
					<button type="submit" class="btn btn-primary">Mark Present</button>
				</form>
			</div>
		</div>
		{% endif %}
	</div>
	{% if not show_code_form %}
	<script>
	const video = document.getElementById('video');
	const out = document.getElementById('out');
	const manualEntry = document.getElementById('manualEntry');
	const manualForm = document.getElementById('manualForm');
	
	async function initCam(){
		try{
			const stream = await navigator.mediaDevices.getUserMedia({ video: true });
			video.srcObject = stream;
		}catch(e){ out.textContent = 'Camera error: ' + e; }
	}
	function frameBlob(){
		const c = document.createElement('canvas');
		c.width = video.videoWidth; c.height = video.videoHeight;
		const ctx = c.getContext('2d');
		ctx.drawImage(video, 0, 0);
		return new Promise(res=> c.toBlob(res, 'image/jpeg', 0.85));
	}
	async function captureFrames(count = 3, delayMs = 150){
		const blobs = [];
		for(let i=0;i<count;i++){
			// wait a bit between frames to catch slight motion
			if(i>0) await new Promise(r=>setTimeout(r, delayMs));
			const b = await frameBlob();
			blobs.push(b);
		}
		return blobs;
	}

	document.getElementById('capture').addEventListener('click', async ()=>{
		const btn = document.getElementById('capture');
		btn.disabled = true;
		btn.textContent = 'Processing...';
		const blobs = await captureFrames(3, 120);
		const form = new FormData();
		blobs.forEach((blob, idx)=> form.append('file', blob, `frame${idx}.jpg`));
		const r = await fetch('/attendance/recognize', { method: 'POST', body: form });
		const j = await r.json();
		if(j.student_id){
			if(j.subject_id){
				// Show success message
				out.innerHTML = `
					<div class="alert alert-success">
						✓ Attendance marked for ${j.student_name || 'Student'} in ${j.subject_name || 'subject'}
					</div>
				`;
				// Reload the page to show flash message
				setTimeout(() => location.reload(), 1500);
			} else {
				out.innerHTML = `
					<div class="alert alert-warning">
						⚠️ No matching class found for ${j.student_name || 'Student'} at this time.
						Please select the subject manually.
					</div>
				`;
				manualEntry.style.display = 'block';
				// Load subjects for manual entry
				loadSubjectsForManualEntry(j.student_id);
			}
		}else{
			out.innerHTML = '<div class="alert alert-error">✗ Face not recognized. Please try again.</div>';
		}
		btn.disabled = false;
		btn.textContent = 'Mark Present';
	});
	
	let currentStudentId = null;
	function loadSubjectsForManualEntry(studentId) {
		currentStudentId = studentId;
		fetch('/attendance/get-subjects?student_id=' + studentId)
			.then(r => r.json())
			.then(data => {
				const select = document.getElementById('manual_subject');
				select.innerHTML = '<option value="">-- Select Subject --</option>';
				data.subjects.forEach(s => {
					const opt = document.createElement('option');
					opt.value = s.id;
					opt.textContent = s.name;
					select.appendChild(opt);
				});
			});
	}
	
	manualForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const day = document.getElementById('manual_day').value;
		const subject = document.getElementById('manual_subject').value;
		if (!subject) {
			alert('Please select a subject');
			return;
		}
		const form = new FormData();
		form.append('student_id', currentStudentId);
		form.append('day', day);
		form.append('subject_id', subject);
		const r = await fetch('/attendance/manual', { method: 'POST', body: form });
		const j = await r.json();
		if (j.success) {
			out.innerHTML = '<div class="alert alert-success">✓ Attendance marked successfully!</div>';
			manualEntry.style.display = 'none';
		} else {
			out.innerHTML = '<div class="alert alert-error">✗ Error: ' + (j.error || 'Failed to mark attendance') + '</div>';
		}
	});
	
	initCam();
	</script>
	{% endif %}
</body>
</html>
